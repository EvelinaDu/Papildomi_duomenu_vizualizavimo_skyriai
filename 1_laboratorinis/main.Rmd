# Bibliotekos

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(GGally)
library(patchwork)
```

# Duomenų paruošimas

```{r}

data <- read.csv("loan_data.csv")
data <- data %>%
  mutate(across(c(credit.policy, not.fully.paid, purpose), as.factor))

data <- data %>% 
  mutate(annual.inc = exp(log.annual.inc))

nrow(data)
length(data)

data %>%
  summarise(across(everything(), ~ sum(is.na(.))))
```

```{r}
set.seed(2026)
sampled_data <- data %>%
  group_by(purpose, credit.policy) %>%
  slice_sample(prop = 0.4) %>%
  ungroup()
```

```{r}
nrow(sampled_data)
head(sampled_data)
summary(sampled_data)
str(sampled_data)
```

## Išskirtys

```{r}
count_outliers <- function(data, var_name) {
  data %>%
    summarise(
      variable = var_name,
      Q1 = quantile(.data[[var_name]], 0.25),
      Q3 = quantile(.data[[var_name]], 0.75),
      H = Q3 - Q1,
      inner_low = Q1 - 1.5*H,
      inner_high = Q3 + 1.5*H,
      outer_low = Q1 - 3*H,
      outer_high = Q3 + 3*H,
      mild_outliers = sum(.data[[var_name]] < inner_low | .data[[var_name]] > inner_high),
      extreme_outliers = sum(.data[[var_name]] < outer_low | .data[[var_name]] > outer_high)
      ) #%>% 
    #select(-c(inner_low, inner_high, outer_low, outer_high))
}
```

```{r}
numeric_cols <- sampled_data %>% 
  select(where(is.numeric)) %>% 
  names()

results_list <- lapply(numeric_cols, function(col) count_outliers(sampled_data, col))
outlier_summary <- bind_rows(results_list)
outlier_summary
```

```{r}
results_list <- lapply(numeric_cols, function(col) count_outliers(data, col))
outlier_summary_full <- bind_rows(results_list)
outlier_summary_full
```

```{r}
sampled_data %>%
  select(where(is.numeric)) %>%
  pivot_longer(everything()) %>%
  ggplot(aes(x = name, y = value)) +
  geom_boxplot() +
  facet_wrap(~name, scales = "free") +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
print(paste("Daugiau nei vienas viešasis įrašas: ", sampled_data %>% select(pub.rec) %>% filter(pub.rec > 1) %>% nrow() ))
print(paste("Bent vienas praleistas mokėjimas: ", sampled_data %>% select(delinq.2yrs) %>% filter(delinq.2yrs > 0) %>% nrow() ))
print(paste("Palūkanos didesnės už 20%: ", sampled_data %>% select(int.rate) %>% filter(int.rate > .2) %>% nrow() ))
print(paste("Metinis uždatbis daugiau nei 1 mln.: ", sampled_data %>% select(annual.inc) %>% filter(annual.inc > 1000000) %>% nrow() ))
print(paste("Nesumokėta suma lygi 0: ", sampled_data %>% select(revol.bal) %>% filter(revol.bal == 0) %>% nrow() ))
print(paste("Daugiau nei 25 kreditoių užklausos: ", sampled_data %>% select(inq.last.6mths) %>% filter(inq.last.6mths > 25) %>% nrow() ))
```

```{r}
check_bounds <- function(x, col_name, info) {
  limits <- info[info$variable == col_name, ]
  as.integer(x < as.numeric(limits$outer_low) | x > as.numeric(limits$outer_high))
}
```

```{r}
data_outlier_info <- sampled_data

data_outlier_info <- sampled_data %>%
  mutate(
    across(
      all_of(numeric_cols), 
      ~ check_bounds(.x, cur_column(), outlier_summary),
      .names = "is_out_by_{.col}"
    )
  )

data_outlier_info <- data_outlier_info %>%
  mutate(outlier_dim = rowSums(across(starts_with("is_out_by_")), na.rm = TRUE)) %>%
  arrange(desc(outlier_dim))
```

# Pirminė duomenų analizė

## Skaitinės charakteristikos

```{r}
Modes <- function(x) {
  ux <- unique(x)
  tab <- tabulate(match(x, ux))
  ux[tab == max(tab)][1]
}
```


```{r}
char_function <- function(data, groups, columns){
  data %>%
    group_by(across({{groups}})) %>% 
    select(all_of(columns)) %>% 
    summarise(across(everything(), 
                     list(min = ~min(.x), 
                          max = ~max(.x), 
                          mean = ~mean(.x),
                          sd = ~sd(.x),
                          q25 = ~quantile(.x, 0.25),
                          median = ~median(.x),
                          q75 = ~quantile(.x, 0.75),
                          mode = ~if (cur_column() %in% c("inq.last.6mths", "delinq.2yrs", "pub.rec")){Modes(.x)} else {NA}))) %>% 
  pivot_longer(cols = -{{groups}}) %>% 
    separate(name, into = c("pozymis", "charakteristika"), sep = "_") %>%
    pivot_wider(names_from = pozymis, values_from = value)
}
```

```{r}
indicators <- c("int.rate", "installment", "annual.inc", "dti", "fico", "days.with.cr.line",
         "revol.bal", "revol.util", "inq.last.6mths", "delinq.2yrs", "pub.rec")
char_policy <- char_function(sampled_data, credit.policy, indicators) 
char_purpose <- char_function(sampled_data, purpose, indicators)
```

```{r}
char_combined <- char_function(sampled_data, c(credit.policy, purpose), indicators)
```

```{r}
#char_mean <- char_purpose %>% 
#  filter(grepl("annual.inc_mean", name)) %>% 
#  select(-name)

#char_sd <- char_purpose %>% 
#  filter(grepl("annual.inc_sd", name)) %>% 
#  select(-name)

#char_median <- char_purpose %>% 
#  filter(grepl("annual.inc_median", name)) %>% 
#  select(-name)

#char_mean_sd <- left_join(char_mean, char_sd, by = "purpose")
#colnames(char_mean_sd)[c(2, 3)] <- c("mean", "sd")

#char_mean_sd_median <- left_join(char_mean_sd, char_median, by = "purpose")
#colnames(char_mean_sd_median)[4] <- c("median")
```


```{r}
#ggplot(char_mean_sd_median) +
#  geom_bar(aes(x=purpose, y=mean), stat="identity", fill="grey25", alpha=0.65) +
#  geom_errorbar(aes(x=purpose, ymin=mean-sd, ymax=mean+sd), width=0.4, colour="orange1", alpha=0.9, size=1.1) +
#  geom_point(aes(x=purpose, y=median)) +
#  coord_flip() +
#  labs(x = "Vidurkis", y = "Paskolos tikslas") +
#  theme_bw()
```


## Koreliacijos

```{r fig.height=8, fig.width=8}
numeric_values <- sampled_data %>% 
  select(!credit.policy & !purpose & !not.fully.paid)

cor <- cor(numeric_values)
corrplot(cor, method="number")
```


```{r fig.height=14, fig.width=14, message=FALSE}
scatter_matrix <- ggpairs(numeric_values,
                          title = "Sklaidos diagramų matrica",
                          axisLabels = "show",
                          lower = list(
                            continuous = wrap("points", size = 0.5, alpha = 0.3)
                          ))
scatter_matrix +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r fig.height=15, fig.width=15, message=FALSE}
numeric_values_and_policy <- sampled_data %>% 
  select(!purpose & !not.fully.paid)

scatter_matrix_cat <- ggpairs(
  numeric_values_and_policy,
  title = "Sklaidos diagramų matrica pagal kredito politiką",
  mapping = aes(color = credit.policy),
  lower = list(
    continuous = wrap("points", size = 0.5, alpha = 0.3)
  ),
  diag = list(
    continuous = wrap("densityDiag", alpha = 0.4)
  )
)

scatter_matrix_cat +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r fig.height=8, fig.width=10}
int_rate_fico <- ggplot(sampled_data, aes(x = int.rate, 
                         y = fico, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Palūkanų norma ir FICO reitingas",
    x = "Palūkanos",
    y = "FICO",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

revol_bal_fico <- ggplot(sampled_data, aes(x = fico, 
                         y = revol.bal, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "FICO reitingas ir atnaujinamas balansas",
    x = "FICO",
    y = "Atnaujinamas balansas",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

int_rate_revol_bal <- ggplot(sampled_data, aes(x = int.rate, 
                         y = revol.bal, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Palūkanų norma ir atnaujinamas balansas",
    x = "Palūkanos",
    y = "Atnaujinamas balansas",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )


installment_annual_inc <- ggplot(sampled_data, aes(x = installment, 
                         y = log.annual.inc, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) + 
  labs(
    title = "Mėnesinė įmoka ir metinių pajamų logaritmas",
    x = "Įmoka",
    y = "Pajamos (log)",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

corr_plot <- (
  (int_rate_fico + revol_bal_fico) /
  (int_rate_revol_bal + installment_annual_inc)
) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

corr_plot +
  plot_annotation(
    title = "Paskolų rodiklių tarpusavio ryšiai pagal kredito politiką",
    theme = theme(
      plot.title = element_text(hjust = 0.5)
    )
  )

```


```{r}
ggplot(sampled_data, aes(x = purpose, y = fico, color = as.factor(credit.policy))) +
  geom_jitter(alpha = 0.5, size = 2, width = 0.4) +
  theme_minimal() +
  labs(title = "Kredito politika pagal FICO ir paskirtį",
       x = "Paskolos paskirtis",
       y = "FICO reitingas",
       color = "Kredito politika") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


Normavimas

```{r}
min_max_normalization <- function(x){
  return((x-min(x)) / (max(x)-min(x)))
}
```

```{r}
min_max_normalized <- sampled_data %>% 
  select(where(is.numeric)) %>% 
  mutate(across(everything(), min_max_normalization))
```

```{r}
mean_sd_normalization <- function(x){
  return((x-mean(x)) / sd(x))
}
```

```{r}
mean_sd_normalized <- sampled_data %>% 
  select(where(is.numeric)) %>% 
  mutate(across(everything(), mean_sd_normalization))
```
