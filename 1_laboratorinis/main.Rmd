# Bibliotekos

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(GGally)
library(patchwork)
```

# Duomenų paruošimas

```{r}

data <- read.csv("loan_data.csv")
data <- data %>%
  mutate(across(c(credit.policy, not.fully.paid, purpose), as.factor))

data <- data %>% 
  mutate(annual.inc = exp(log.annual.inc))

nrow(data)
length(data)

data %>%
  summarise(across(everything(), ~ sum(is.na(.))))
```

```{r}
set.seed(6202)
sampled_data <- data %>%
  group_by(purpose, credit.policy) %>%
  slice_sample(prop = 0.4) %>%
  ungroup()
```

```{r}
nrow(sampled_data)
head(sampled_data)
summary(sampled_data)
str(sampled_data)
```

```{r}
purpose_table <- table(sampled_data$purpose)
cp_table <- table(sampled_data$credit.policy)

purpose_cp_table <- table(sampled_data$purpose, sampled_data$credit.policy)
```

# Pirminė duomenų analizė

## Išskirtys

```{r}
count_outliers <- function(data, var_name) {
  data %>%
    summarise(
      variable = var_name,
      Q1 = quantile(.data[[var_name]], 0.25),
      Q3 = quantile(.data[[var_name]], 0.75),
      H = Q3 - Q1,
      inner_low = Q1 - 1.5*H,
      inner_high = Q3 + 1.5*H,
      outer_low = Q1 - 3*H,
      outer_high = Q3 + 3*H,
      mild_outliers = sum(.data[[var_name]] < inner_low | .data[[var_name]] > inner_high),
      extreme_outliers = sum(.data[[var_name]] < outer_low | .data[[var_name]] > outer_high)
      ) #%>% 
    #select(-c(inner_low, inner_high, outer_low, outer_high))
}
```

```{r}
numeric_cols <- sampled_data %>% 
  select(where(is.numeric)) %>% 
  names()

results_list <- lapply(numeric_cols, function(col) count_outliers(sampled_data, col))
outlier_summary <- bind_rows(results_list)
outlier_summary
```

```{r}
results_list <- lapply(numeric_cols, function(col) count_outliers(data, col))
outlier_summary_full <- bind_rows(results_list)
outlier_summary_full
```

```{r}
sampled_data %>%
  select(where(is.numeric)) %>%
  pivot_longer(everything()) %>%
  ggplot(aes(x = name, y = value)) +
  geom_boxplot() +
  facet_wrap(~name, scales = "free") +
  theme_bw() +
  theme(legend.position = "none")
```

```{r}
print(paste("Daugiau nei vienas viešasis įrašas: ", sampled_data %>% select(pub.rec) %>% filter(pub.rec > 1) %>% nrow() ))
print(paste("Bent vienas praleistas mokėjimas: ", sampled_data %>% select(delinq.2yrs) %>% filter(delinq.2yrs > 0) %>% nrow() ))
print(paste("Palūkanos didesnės už 20%: ", sampled_data %>% select(int.rate) %>% filter(int.rate > .2) %>% nrow() ))
print(paste("Metinis uždatbis daugiau nei 1 mln.: ", sampled_data %>% select(annual.inc) %>% filter(annual.inc > 1000000) %>% nrow() ))
print(paste("Nesumokėta suma lygi 0: ", sampled_data %>% select(revol.bal) %>% filter(revol.bal == 0) %>% nrow() ))
print(paste("Daugiau nei 25 kreditoių užklausos: ", sampled_data %>% select(inq.last.6mths) %>% filter(inq.last.6mths > 25) %>% nrow() ))
```

```{r}
check_bounds <- function(x, col_name, info) {
  limits <- info[info$variable == col_name, ]
  as.integer(x < as.numeric(limits$outer_low) | x > as.numeric(limits$outer_high))
}
```

```{r}
data_outlier_info <- sampled_data

data_outlier_info <- sampled_data %>%
  mutate(
    across(
      all_of(numeric_cols), 
      ~ check_bounds(.x, cur_column(), outlier_summary),
      .names = "is_out_by_{.col}"
    )
  )

data_outlier_info <- data_outlier_info %>%
  mutate(outlier_dim = rowSums(across(starts_with("is_out_by_")), na.rm = TRUE)) %>%
  arrange(desc(outlier_dim))
```

```{r}
data_outlier_info <- data_outlier_info %>%
  mutate(is_outlier = as.integer(outlier_dim > 1) )
```

```{r fig.height=5, fig.width=8, message=FALSE, warning=FALSE}
gg_n_dim_outliers <- data_outlier_info %>%
  group_by(credit.policy, purpose) %>% 
  summarise(sum = sum(is_outlier),
            n = n(),
            value = round(sum/n, 2)) %>% 
  ggplot(aes(x = purpose, y = credit.policy, size = value, color = value)) +
  geom_point() +
  geom_text(aes(label = value), 
            size = 4,
            color = "black",
            vjust = -3,
            show.legend = FALSE) +
  labs(x = "Paskolos paskirtis",
       y = "Atitinka kredito politika?",
       title = "Ekstremalių daugimačių išskirčių dalis",
       subtitle = "Paskolų smulkiam verslui grupė pasižymi daugeliu išskirčių (22 %).") +
  scale_y_discrete(labels = c("0" = "Ne", "1" = "Taip")) +
  scale_x_discrete(labels = c(
    "all_other" = "Visi kiti",
    "credit_card" = "Kredito kortelė",
    "debt_consolidation" = "Skolų konsolidavimas",
    "educational" = "Edukacinis",
    "home_improvement" = "Namų remontas",
    "major_purchase" = "Svarbus pirkimas",
    "small_business" = "Smulkus verslas"
  )) +
  scale_size(range = c(6, 20)) +
  theme_bw() +
  theme(
    panel.grid.major = element_line(
      color = "grey75",
      linetype = "dashed"
    )
  ) +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "none",
    axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1, size = 11, face = "bold"),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 16),
    plot.subtitle = element_text(size = 10))

gg_n_dim_outliers

#ggsave(filename = "Ekstremalių_daugimačių_išskirčių_dalis.png", width = 8.27, height = 5, units = "in", dpi = 300)
```

## Skaitinės charakteristikos

```{r}
Modes <- function(x) {
  ux <- unique(x)
  tab <- tabulate(match(x, ux))
  ux[tab == max(tab)][1]
}
```

```{r}
char_function <- function(data, groups, columns){
  data %>%
    group_by(across({{groups}})) %>% 
    select(all_of(columns)) %>% 
    summarise(across(everything(), 
                     list(min = ~min(.x), 
                          max = ~max(.x), 
                          mean = ~mean(.x),
                          sd = ~sd(.x),
                          q25 = ~quantile(.x, 0.25),
                          median = ~median(.x),
                          q75 = ~quantile(.x, 0.75),
                          mode = ~if (cur_column() %in% c("inq.last.6mths", "delinq.2yrs", "pub.rec")){Modes(.x)} else {NA}))) %>% 
  pivot_longer(cols = -{{groups}}) %>% 
    separate(name, into = c("pozymis", "charakteristika"), sep = "_") %>%
    pivot_wider(names_from = pozymis, values_from = value)
}
```

```{r}
indicators <- c("int.rate", "installment", "annual.inc", "dti", "fico", "days.with.cr.line",
         "revol.bal", "revol.util", "inq.last.6mths", "delinq.2yrs", "pub.rec")
char_policy <- char_function(sampled_data, credit.policy, indicators) 
char_purpose <- char_function(sampled_data, purpose, indicators)
```

```{r}
char_combined <- char_function(sampled_data, c(credit.policy, purpose), indicators)
```
```{r}
char_mean <- char_combined %>% 
  select(c("credit.policy", "purpose", "charakteristika", "annual.inc")) %>% 
  filter(grepl("mean", charakteristika)) %>% 
  select(-"charakteristika")
colnames(char_mean)[3] <- "annual.inc_mean"

char_sd <- char_combined %>% 
  select(c("credit.policy", "purpose", "charakteristika", "annual.inc")) %>% 
  filter(grepl("sd", charakteristika)) %>% 
  select(-"charakteristika")
colnames(char_sd)[3] <- "annual.inc_sd"

char_median <- char_combined %>% 
  select(c("credit.policy", "purpose", "charakteristika", "annual.inc")) %>% 
  filter(grepl("median", charakteristika)) %>% 
  select(-"charakteristika")
colnames(char_median)[3] <- "annual.inc_median"

char_mean_sd <- left_join(char_mean, char_sd, by = c("purpose", "credit.policy"))
char_mean_sd_median <- left_join(char_mean_sd, char_median, by = c("purpose", "credit.policy"))
```

```{r}
dodge_val <- position_dodge(width = 0.9)
ggplot(char_mean_sd_median) +
  geom_point(aes(x = purpose, y = annual.inc_mean, group = credit.policy, shape = "Vidurkis"), 
             position = dodge_val, size = 3) +
  geom_errorbar(aes(x = purpose,
                    ymin = annual.inc_mean-annual.inc_sd,
                    ymax = annual.inc_mean+annual.inc_sd,
                    color = credit.policy, group = credit.policy),
                width = 0.3, size = 1, position = dodge_val) +
  geom_point(aes(x = purpose, y = annual.inc_median, group = credit.policy, shape = "Mediana"),
             position = dodge_val, size=2) +
  scale_shape_manual(name = "Charakteristika", 
                     values = c("Vidurkis" = 3, "Mediana" = 19)) +
  scale_y_continuous(breaks = seq(0, 228000, 38000)) +
  scale_color_discrete(name = "Atitinka kriterijus", labels = c("Ne","Taip")) +
  scale_x_discrete(labels = c("Visi kiti", "Kredito kortelė", "Skolų konsolidavimas",
                              "Edukacija", "Namų remontas", "Svarbus pirkinys", "Smulkus verslas")) +
  labs(x = "Paskolos tikslas", y = "Matinės pajamos", 
       title = "Metinės pajamos", subtitle = "Klientų negaunančių paskolos grupė, dažnai pasižymi vidutiniškai mažesnėmis pajamomis") +
  coord_flip() +
  geom_hline(yintercept = 0, size = 1, color = "grey80") +
  theme_bw()
```


## Koreliacijos

```{r fig.height=8, fig.width=8}
numeric_values <- sampled_data %>% 
  select(!credit.policy & !purpose & !not.fully.paid)

cor <- cor(numeric_values)
corrplot(cor, method="number")
```

```{r fig.height=14, fig.width=14, message=FALSE}
scatter_matrix <- ggpairs(numeric_values,
                          title = "Sklaidos diagramų matrica",
                          axisLabels = "show",
                          lower = list(
                            continuous = wrap("points", size = 0.5, alpha = 0.3)
                          ))
scatter_matrix +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r fig.height=15, fig.width=15, message=FALSE}
numeric_values_and_policy <- sampled_data %>% 
  select(!purpose & !not.fully.paid)

scatter_matrix_cat <- ggpairs(
  numeric_values_and_policy,
  title = "Sklaidos diagramų matrica pagal kredito politiką",
  mapping = aes(color = credit.policy),
  lower = list(
    continuous = wrap("points", size = 0.5, alpha = 0.3)
  ),
  diag = list(
    continuous = wrap("densityDiag", alpha = 0.4)
  )
)

scatter_matrix_cat +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r fig.height=8, fig.width=10}
int_rate_fico <- ggplot(sampled_data, aes(x = int.rate, 
                         y = fico, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Palūkanų norma ir FICO reitingas",
    x = "Palūkanos",
    y = "FICO",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

revol_bal_fico <- ggplot(sampled_data, aes(x = fico, 
                         y = revol.bal, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "FICO reitingas ir atnaujinamas balansas",
    x = "FICO",
    y = "Atnaujinamas balansas",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

int_rate_revol_bal <- ggplot(sampled_data, aes(x = int.rate, 
                         y = revol.bal, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Palūkanų norma ir atnaujinamas balansas",
    x = "Palūkanos",
    y = "Atnaujinamas balansas",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )


installment_annual_inc <- ggplot(sampled_data, aes(x = installment, 
                         y = log.annual.inc, 
                         color = credit.policy)) +
  geom_point(size = 1.5, alpha = 0.5) +
  #geom_smooth(method = "lm", se = FALSE) + 
  labs(
    title = "Mėnesinė įmoka ir metinių pajamų logaritmas",
    x = "Įmoka",
    y = "Pajamos (log)",
    color = "Kredito politika"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

corr_plot <- (
  (int_rate_fico + revol_bal_fico) /
  (int_rate_revol_bal + installment_annual_inc)
) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

corr_plot +
  plot_annotation(
    title = "Paskolų rodiklių tarpusavio ryšiai pagal kredito politiką",
    theme = theme(
      plot.title = element_text(hjust = 0.5)
    )
  )

```


```{r}
ggplot(sampled_data, aes(x = purpose, y = fico, color = as.factor(credit.policy))) +
  geom_jitter(alpha = 0.5, size = 2, width = 0.4) +
  theme_minimal() +
  labs(title = "Kredito politika pagal FICO ir paskirtį",
       x = "Paskolos paskirtis",
       y = "FICO reitingas",
       color = "Kredito politika") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Duomenų aibės normavimas

```{r}
min_max_normalization <- function(x){
  return((x-min(x)) / (max(x)-min(x)))
}
```

```{r}
min_max_normalized <- sampled_data %>% 
  select(where(is.numeric)) %>% 
  mutate(across(everything(), min_max_normalization))
```

```{r}
mean_sd_normalization <- function(x){
  return((x-mean(x)) / sd(x))
}
```

```{r}
mean_sd_normalized <- sampled_data %>% 
  select(where(is.numeric)) %>% 
  mutate(across(everything(), mean_sd_normalization))
```


## Papildomos vizualizacijos

### Kredito politikos atitikimas pagal paskolos paskirtį

```{r fig.height=6, fig.width=10}
ggplot(sampled_data,
       aes(x = purpose, fill = factor(credit.policy))) +
  geom_bar(position = "fill") +
  labs(
    title = "Kredito politikos atitikimas pagal paskolos paskirtį",
    x = "Paskolos paskirtis",
    y = "Dalis",
    fill = "Kredito politika"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(hjust = 0.5),
    legend.position = "bottom"
  )
```


```{r}
ggplot(sampled_data,
       aes(x = purpose,
           y = fico,
           fill = factor(credit.policy))) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "FICO pasiskirstymas pagal paskolos paskirtį ir kredito politiką",
    x = "Paskolos paskirtis",
    y = "FICO",
    fill = "Kredito politika"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )
```


